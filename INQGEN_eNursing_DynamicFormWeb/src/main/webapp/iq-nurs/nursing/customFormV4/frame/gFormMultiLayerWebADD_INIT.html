<script>
//頁面載入完成
function pageReady(){
    $("#loadeffect").hide();
    if (window.console) console.log("頁面載入完成(父層)...");

    $(".showFrame").each(function(){
        this.contentWindow.location.href = stopIframeCache(getDataset(this).src);
    });
    $(".tabcontent").height(document.body.clientHeight-$(".tab")[0].offsetTop-120);
    openCusTab('tab_1');
}


//基础参数
var basicParam = null;
//動態表單
var dynamicForm = null;
//gForm
var gFormJS = null;
//動態表單模板
var dynamicFormTemplate = null;
//formId
var formId = null;

gFormJS = nursing.createGForm();
gFormJS.getGFormId(gFormJS,
    function (_formId){
        formId = _formId;

        /**********設定localStorage Start********/
        //第一個分頁
        var multiLevelSet = "a1";
        //設定Title
        window.localStorage["gFormWebADD_headerTitle"+multiLevelSet] = "病人病情狀況";
        //設定此form的sourceId
        window.localStorage["gFormWebADD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebADD_formType"+multiLevelSet] = "PDR1";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebADD_frameModel"+multiLevelSet] = "gFormWebADD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebADD_frameModel_INIT"+multiLevelSet] = "gFormWebADD_INIT";
        //設定Title
        window.localStorage["gFormWebUPD_headerTitle"+multiLevelSet] = "病人病情狀況";
        //設定此form的sourceId
        window.localStorage["gFormWebUPD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebUPD_formType"+multiLevelSet] = "PDR1";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebUPD_frameModel"+multiLevelSet] = "gFormWebUPD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebUPD_frameModel_INIT"+multiLevelSet] = "gFormWebUPD_INIT";

        //第二個分頁
        var multiLevelSet = "b1";
        //設定Title
        window.localStorage["gFormWebADD_headerTitle"+multiLevelSet] = "病人外出前評估";
        //設定此form的sourceId
        window.localStorage["gFormWebADD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebADD_formType"+multiLevelSet] = "PDR2";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebADD_frameModel"+multiLevelSet] = "gFormWebADD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebADD_frameModel_INIT"+multiLevelSet] = "gFormWebADD_INIT";
        //設定Title
        window.localStorage["gFormWebUPD_headerTitle"+multiLevelSet] = "病人外出前評估";
        //設定此form的sourceId
        window.localStorage["gFormWebUPD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebUPD_formType"+multiLevelSet] = "PDR2";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebUPD_frameModel"+multiLevelSet] = "gFormWebUPD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebUPD_frameModel_INIT"+multiLevelSet] = "gFormWebUPD_INIT";

        //第三個分頁
        var multiLevelSet = "c1";
        //設定Title
        window.localStorage["gFormWebADD_headerTitle"+multiLevelSet] = "檢查(治療、手術)單位評估";
        //設定此form的sourceId
        window.localStorage["gFormWebADD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebADD_formType"+multiLevelSet] = "PDR-03";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebADD_frameModel"+multiLevelSet] = "gFormWebADD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebADD_frameModel_INIT"+multiLevelSet] = "gFormWebADD_INIT";
        //設定Title
        window.localStorage["gFormWebUPD_headerTitle"+multiLevelSet] = "檢查(治療、手術)單位評估";
        //設定此form的sourceId
        window.localStorage["gFormWebUPD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebUPD_formType"+multiLevelSet] = "PDR-03";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebUPD_frameModel"+multiLevelSet] = "gFormWebUPD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebUPD_frameModel_INIT"+multiLevelSet] = "gFormWebUPD_INIT";

        //第四個分頁
        var multiLevelSet = "d1";
        //設定Title
        window.localStorage["gFormWebADD_headerTitle"+multiLevelSet] = "護理站病人返室評估";
        //設定此form的sourceId
        window.localStorage["gFormWebADD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebADD_formType"+multiLevelSet] = "PDR-04";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebADD_frameModel"+multiLevelSet] = "gFormWebADD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebADD_frameModel_INIT"+multiLevelSet] = "gFormWebADD_INIT";
        //設定Title
        window.localStorage["gFormWebUPD_headerTitle"+multiLevelSet] = "護理站病人返室評估";
        //設定此form的sourceId
        window.localStorage["gFormWebUPD_sourceId"+multiLevelSet] = formId;
        //設定此form的formType
        window.localStorage["gFormWebUPD_formType"+multiLevelSet] = "PDR-04";
        //設定此page的對應功能頁面
        window.localStorage["gFormWebUPD_frameModel"+multiLevelSet] = "gFormWebUPD";
        //設定此page的對應功能頁面程式
        window.localStorage["gFormWebUPD_frameModel_INIT"+multiLevelSet] = "gFormWebUPD_INIT";
        /**********設定localStorage End********/

        //在動態表單都會用到的JS、CSS在這邊一併引入
        includeHead(function(){
            //在動態表單都會共用的JS程式，在這邊統一執行
            includeFoot(completeFoot);
        });
    }
);

var completeCount=0;

//foot運行完了之後再執行
function completeFoot() {
    //病患資料
    patient=nursing.getPatient().getCurrent();

    //基础参数
    basicParam = nursing.getBasicParam();
    //動態表單
    dynamicForm = nursing.getDynamicForm();
    //gForm
    gFormJS = nursing.createGForm();
    gFormJS.formType = formType;
    gFormJS.formId = formId;
    gFormJS.searchParamGF.sourceId = sourceId;
    gFormJS.searchParamGF.multiLevelADD = "true";
    gFormJS.searchParamGF.userId = userId;
    gFormJS.searchParamGF.userName = userName;

    //依據formModel(表單名)、frameModel(對應頁面) 取得最新版的formFrame(表單外框)
    dynamicForm.searchParamDF.formType = formType;
    dynamicForm.searchParamDF.frameModel = frameModel;
    if (window.localStorage["loadEditorFrame_Frame"]){//以管理介面導入頁面
        window.localStorage.removeItem("loadEditorFrame_Frame");
        //因代碼風險關係自2022.04.08之後已作廢
        // successCall(JSON.parse(window.localStorage["loadEditorFrame_Frame_context"]));
        window.localStorage.removeItem("loadEditorFrame_Frame_context");
        //2022.04.08之後改用
        successCall(JSON.parse(parent.$("#previewIframe").data("loadEditorFrame_Frame_context")));
    }else if(loadLocalFrame && formType==loadLocalFrame_formType){//讀取本地端frame
        $.ajax({url: "frame/gFormMultiLayerWebADD_Frame.html", cache: false, async: false}).done(function( context ) {successCall({"version":0,"content":context});}).fail(function(err){successCall("未找到本地端表单模板...");});
    }else{//讀取資料庫frame
        basicParam.getCurrDynamicFormFrameByformTypeFrameModel(dynamicForm, successCall, function() {});
    }
    //查詢formFrame(表單外框)
    var call = false;
    function successCall (formFrame) {
        if (call) return; else call=true;
        //沒有模板資料
        if (formFrame==null){
            $("#targetForm").html('<div class="form-group" ><div class="col-xs-12 col-md-12">表单模板未配对...</div></div>');
            $("#loadeffect").hide();
        }else{
            var newVersionNo = parseInt(formFrame.newVersionNo);
            versionNo = (newVersionNo>versionNo) ? newVersionNo : versionNo;
            //將資料庫的formFrame 引入到body裡面的#targetForm
            $("#targetForm").html('<div id="pageResult">'+formFrame.content+'</div>');
            successCall3();
        }
    }

    //查詢動態表單模板
    dynamicForm.searchParamDF.formType = formType;
    if (window.localStorage["loadEditorFrame_formVersion"]){//以管理介面導入頁面
        window.localStorage.removeItem("loadEditorFrame_formVersion");
        //因代碼風險關係自2022.04.08之後已作廢
        // successCall2(JSON.parse(window.localStorage["loadEditorFrame_formVersion_dFTemplate"]));
        window.localStorage.removeItem("loadEditorFrame_formVersion_dFTemplate");
        //2022.04.08之後改用
        successCall2(JSON.parse(parent.$("#previewIframe").attr("loadEditorFrame_formVersion_dFTemplate")));
    }else{//讀取資料庫formVersion
        basicParam.getCurrDynamicFormTemplateV3(dynamicForm, successCall2, function() {});
    }

    //查詢動態表單
    var call2 = false;
    function successCall2 (dFTemplate) {
        if (call2) return; else call2=true;
        //顯示XML模板
        dynamicFormTemplate = dFTemplate[0].basicParam.dynamicFormTemplate;
        successCall3();
    }

    function successCall3(){
        if (++completeCount<2) return;
        var formItemsTemplate = dynamicFormTemplate.hashItems;
        createElement(formItemsTemplate, pageReady);
        //取得版本號 (如果前兩個frame的versionNo皆為0，就以xml的版本為versionNo)
        var version = parseInt(dynamicFormTemplate.version);
        versionNo = (version>versionNo) ? version : versionNo;
    }
}

function openCusTab(tabName)
{
  var i, tabcontent, tablinks;
  $(".tabcontent").addClass("tab_hidden");
  $(".tabcontent").removeClass("tab_block");
  $(".tablinks").removeClass("active");
  $("#"+tabName).addClass("tab_hidden").addClass("tab_block").addClass("active");
}
</script>